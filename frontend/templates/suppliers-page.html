{% extends 'base.html' %}

{% block content %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Список поставщиков</h2>
    <button class="btn btn-success" id="addSupplierBtn">Добавить поставщика</button>
  </div>

  <!-- Поиск -->
  <div class="input-group mb-4">
    <input type="text" class="form-control" placeholder="Поиск по названию" id="searchInput" value="{{ request.GET.q|default:'' }}">
    <button class="btn btn-outline-primary" type="button" id="searchBtn">Найти</button>
    <button class="btn btn-outline-secondary" type="button" id="resetSearchBtn">Сбросить</button>
  </div>

  <!-- Таблица -->
  <div class="table-responsive">
    <table class="table table-hover align-middle" id="suppliers-table">
      <thead class="table-light">
        <tr>
          <th>Название</th>
          <th>Описание</th>
          <th>Дата добавления</th>
          <th>Последнее обращение</th>
        </tr>
      </thead>
      <tbody>
        <!-- Данные будут загружены через JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Сообщение при отсутствии данных -->
  <div class="alert alert-info d-none" id="noDataAlert">
    Поставщики не найдены. Хотите <a href="#" id="addNewSupplierLink">добавить нового поставщика</a>?
  </div>
</div>

<!-- Модальное окно -->
<div class="modal fade" id="supplierModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="supplierForm">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Редактировать поставщика</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="supplierId">
        <div class="mb-3">
          <label for="supplierName" class="form-label">Название <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="supplierName" required>
          <div class="invalid-feedback">Пожалуйста, укажите название поставщика</div>
        </div>
        <div class="mb-3">
          <label for="supplierDescription" class="form-label">Описание</label>
          <textarea class="form-control" id="supplierDescription" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
        <button type="button" class="btn btn-danger me-auto" id="deleteBtn">Удалить</button>
        <button type="submit" class="btn btn-primary" id="saveBtn">Сохранить</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block externals %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const tableBody = document.querySelector("#suppliers-table tbody");
  const searchInput = document.getElementById("searchInput");
  const searchBtn = document.getElementById("searchBtn");
  const resetSearchBtn = document.getElementById("resetSearchBtn");
  const addBtn = document.getElementById("addSupplierBtn");
  const noDataAlert = document.getElementById("noDataAlert");
  const addNewSupplierLink = document.getElementById("addNewSupplierLink");

  // Модальное окно
  const supplierModal = new bootstrap.Modal(document.getElementById("supplierModal"));
  const supplierForm = document.getElementById("supplierForm");
  const modalTitle = document.getElementById("modalTitle");
  const supplierIdInput = document.getElementById("supplierId");
  const nameInput = document.getElementById("supplierName");
  const descInput = document.getElementById("supplierDescription");
  const deleteBtn = document.getElementById("deleteBtn");

  // Состояние приложения
  let searchQuery = '';
  let lastRequestKey = '';
  let isRequestInProgress = false;
  const requestCache = new Map();
  let allSuppliers = [];

  // Загрузка данных
  async function loadSuppliers(q = '') {
    const params = new URLSearchParams();
    if (q) params.append('q', q);
    
    const url = `/api/v1/suppliers/${params.toString() ? '?' + params.toString() : ''}`;
    const cacheKey = q;

    // Сбрасываем кэш для всегда свежих данных
    requestCache.clear();
    isRequestInProgress = true;
    
    try {
      console.log('Загрузка данных с URL:', url);
      const response = await fetch(url);
      if (!response.ok) throw new Error('Ошибка загрузки данных');
      const data = await response.json();
      
      console.log('Получены данные:', data.length);
      
      // Кэширование ответа
      requestCache.set(cacheKey, data);
      allSuppliers = data;
      processResponse(data);
    } catch (error) {
      console.error('Error:', error);
      alert('Произошла ошибка при загрузке данных');
    } finally {
      isRequestInProgress = false;
    }
  }

  function processResponse(data) {
    console.log('Обработка данных:', data);
    if (Array.isArray(data)) {
      renderSuppliers(data);
      toggleNoDataAlert(data.length === 0);
    } else if (data.results && Array.isArray(data.results)) {
      // Если API возвращает формат с пагинацией, несмотря на её отключение
      renderSuppliers(data.results);
      toggleNoDataAlert(data.results.length === 0);
    } else {
      console.error('Неверный формат данных:', data);
      toggleNoDataAlert(true);
    }
  }

  // Отображение списка поставщиков
  function renderSuppliers(suppliers) {
    console.log('Рендерим список поставщиков:', suppliers);
    tableBody.innerHTML = '';
    
    if (!suppliers || suppliers.length === 0) {
      noDataAlert.classList.remove("d-none");
      return;
    }

    noDataAlert.classList.add("d-none");
    suppliers.forEach(supplier => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${escapeHtml(supplier.name)}</td>
        <td>${supplier.description ? escapeHtml(supplier.description) : "-"}</td>
        <td>${formatDate(supplier.date_added)}</td>
        <td>${formatDate(supplier.last_accessed)}</td>
      `;
      row.addEventListener("click", () => openModal(supplier));
      row.style.cursor = "pointer";
      tableBody.appendChild(row);
    });
  }

  // Обработчики событий с debounce
  const debouncedSearch = debounce(() => {
    const newQuery = searchInput.value.trim();
    if (newQuery !== searchQuery) {
      searchQuery = newQuery;
      requestCache.clear(); // Очищаем кэш при новом поиске
      loadSuppliers(searchQuery);
    }
  }, 300);
  
  searchBtn.addEventListener("click", debouncedSearch);
  searchInput.addEventListener("keypress", (e) => e.key === "Enter" && debouncedSearch());

  resetSearchBtn.addEventListener("click", () => {
    if (searchQuery !== '') {
      searchInput.value = '';
      searchQuery = '';
      requestCache.clear();
      loadSuppliers();
    }
  });

  // Вспомогательные функции
  function debounce(func, delay) {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  function toggleNoDataAlert(show) {
    if (show) {
      noDataAlert.classList.remove("d-none");
      tableBody.innerHTML = '';
    } else {
      noDataAlert.classList.add("d-none");
    }
  }

  // Открытие модального окна для редактирования
  function openModal(supplier) {
    modalTitle.textContent = "Редактировать поставщика";
    supplierIdInput.value = supplier.id;
    nameInput.value = supplier.name;
    descInput.value = supplier.description || "";
    deleteBtn.classList.remove("d-none");
    supplierModal.show();
  }

  // Открытие модального окна для добавления
  addBtn.addEventListener("click", () => {
    modalTitle.textContent = "Добавить поставщика";
    nameInput.classList.remove('is-invalid')
    nameInput.nextElementSibling.textContent = ''
    supplierIdInput.value = "";
    nameInput.value = "";
    descInput.value = "";
    deleteBtn.classList.add("d-none");
    supplierModal.show();
  });

  addNewSupplierLink.addEventListener("click", (e) => {
    e.preventDefault();
    addBtn.click();
  });

  // Обработка формы
  supplierForm.addEventListener("submit", (e) => {
    e.preventDefault();
    saveSupplier();
  });

  // Сохранение поставщика
  function saveSupplier() {
    const id = supplierIdInput.value;
    const method = id ? "PUT" : "POST";
    const url = id ? `/api/v1/suppliers/${id}/` : "/api/v1/suppliers/";
    
    if (!nameInput.value.trim()) {
      nameInput.classList.add("is-invalid");
      return;
    }
    
    fetch(url, {
      method: method,
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      body: JSON.stringify({
        name: nameInput.value.trim(),
        description: descInput.value.trim()
      })
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(err => { 
          // Обработка ошибки дубликата имени
          if (err.name && err.name[0].includes('уже существует')) {
            nameInput.classList.add("is-invalid");
            nameInput.nextElementSibling.textContent = err.name;
          }
          throw err; 
        });
      }
      return response.json();
    })
    .then(() => {
      supplierModal.hide();
      // После сохранения немедленно перезагружаем данные
      console.log('Поставщик сохранен, обновляем данные');
      setTimeout(() => loadSuppliers(searchQuery), 100);
    })
    .catch(error => {
      console.error("Error:", error);
      // Уже обработали ошибку дубликата выше, другие ошибки показываем здесь
      if (!error.name) {
        alert(error.detail || "Произошла ошибка при сохранении");
      }
    });
  }

  // Удаление поставщика
  deleteBtn.addEventListener("click", () => {
    const id = supplierIdInput.value;
    if (!id || !confirm("Вы уверены, что хотите удалить этого поставщика?")) return;
    
    fetch(`/api/v1/suppliers/${id}/`, {
      method: "DELETE",
      headers: {
        "X-CSRFToken": getCSRFToken()
      }
    })
    .then(response => {
      if (!response.ok) throw new Error("Ошибка при удалении");
      supplierModal.hide();
      console.log('Поставщик удален, обновляем данные');
      setTimeout(() => loadSuppliers(searchQuery), 100);
    })
    .catch(error => {
      console.error("Error:", error);
      alert("Произошла ошибка при удалении");
    });
  });

  // Валидация формы
  nameInput.addEventListener("input", () => {
    if (nameInput.value.trim()) {
      nameInput.classList.remove("is-invalid");
    }
  });

  // Вспомогательные функции
  function getCSRFToken() {
    const cookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
    return cookie ? cookie.split('=')[1] : '';
  }

  function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
      .toString()
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // Первоначальная загрузка данных
  loadSuppliers();
});
</script>
{% endblock %}